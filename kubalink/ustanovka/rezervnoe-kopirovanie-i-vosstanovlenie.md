# Резервное копирование и восстановление

### Резервное копирование

Для настройки регулярного резервного копирования базы данных и пользовательских файлов в PostgreSQL, можно использовать два основных метода: создание дампа базы данных (dump) или генерация SQL-скрипта. Оба подхода имеют свои особенности. Дамп базы данных создаёт полную резервную копию, которая обеспечивает безопасность данных, тогда как SQL-скрипт сохраняет структуру и данные в виде команд, которые можно выполнить для восстановления базы. Для выбора оптимального метода рекомендуется ознакомиться с документацией по команде `pg_dump` и выбрать подходящие параметры в зависимости от ваших потребностей.

Ниже приведены две команды для создания резервных копий базы данных. Вы можете выбрать одну из них и добавить в свой crontab для автоматического выполнения.

```
# SQL-script
sudo -u postgres pg_dump --no-acl -Fp -Z 5 cubalink > /backup/cubalink.sql.gz

# DUMP
sudo -u postgres pg_dump --no-acl -Fc cubalink > /backup/cubalink.dump
```

Для создания базовой резервной копии файлов можно применить следующую команду:

```
sudo tar -czf /backup/cubalink.tgz .env common/config/settings.json var/attachments
```

Этих файлов вместе с базой данных будет достаточно для восстановления работы Cubalink. Но вы можете выполнять резервное копирование всего каталога /var/www/erp для большей надежности.

### Восстановление из резервной копии

Для восстановления из дампа применяется команда `pg_restore`. Подробности использования можно найти в [документации](https://postgrespro.ru/docs/postgresql/16/app-pgrestore) по `pg_restore`. Если копия представлена SQL-скриптом, то для восстановления нужно использовать утилиту `psql`. Документация по `psql` доступна [для ознакомления](https://wiki.cuba-link.ru/attachments/5).

**SQL-скрипт**\
Чтобы восстановить базу данных из SQL-скрипта, сначала необходимо создать новую базу данных, а затем восстановить в неё данные из резервной копии.

```
sudo -u postgres dropdb cubalink
sudo -u postgres createdb -e -E "UTF-8" -l "ru_RU.UTF-8" -O cubalink -T template0 cubalink
sudo -u postgres psql -d cubalink -c "CREATE EXTENSION postgis"
gunzip < cubalink.sql.gz | sudo -u postgres psql -d cubalink -v ON_ERROR_STOP=1
```

**DUMP**\
Дамп включает в себя полную базу данных со всеми её компонентами. Поэтому перед восстановлением базы из дампа, база данных должна быть удалена с сервера, если она уже существует. Также важно, чтобы пользователь базы данных (владелец всех объектов) был создан заранее. Если вы восстанавливаете базу на новом сервере, убедитесь, что нужный пользователь уже существует. Имейте в виду, что структура дампа может не совпадать между разными версиями PostgreSQL. Это не всегда так, но вероятность несовместимости существует. Для восстановления из дампа используйте следующие команды:

```
sudo -u postgres dropdb cubalink
sudo -u postgres pg_restore --clean --if-exists --create --exit-on-error --dbname=postgres cubalink.dump
```

Обратите внимание, что имя базы данных в команде обязательно должно быть postgres, так как из дампа восстанавливается вся база данных целиком, а не ее содержимое.

**После восстановления базы данных**

После восстановления базы данных любым способом, необходимо очистить кэш САП Кубалинк, т.к. в кэше теперь находятся данные, отличные от данных в базе. Перейдите в каталог /var/www/erp и выполните команду очистки кэша:

```
cd /var/www/erp
php run cache/flush-all
```

И выполните команду восстановления, которая в том числе проверит систему на целостность.

```
sudo -u www-data php install.phar repair
```
